---
- name: Configure wsl
  hosts: all
  gather_facts: true
  pre_tasks:
    - name: Validate Ansible version
      ansible.builtin.assert:
        that: ansible_version.full is version('2.16.1', '>=')
        fail_msg: 'Ansible version 2.16.1 or higher is required'
      tags: validation

    - name: Check if running on WSL2
      ansible.builtin.set_fact:
        is_wsl2: "{{ ansible_facts['os_family'] == 'Debian' and 'microsoft-standard-WSL2' in ansible_facts['kernel'] }}"
      tags: validation, wsl

    - name: Display WSL2 status
      ansible.builtin.debug:
        msg: "WSL2 environment: {{ 'detected' if is_wsl2 else 'not detected - skipping WSL role' }}"
      tags: validation, wsl

  tasks:
    - name: Include wsl role
      ansible.builtin.include_role:
        name: net.markfaine.wsl
      when: is_wsl2 | default(false)
      tags: wsl

  post_tasks:
    - name: Verify WSL configuration was applied
      ansible.builtin.stat:
        path: /etc/wsl.conf
      register: wsl_conf_check
      failed_when: not wsl_conf_check.stat.exists
      when:
        - is_wsl2 | default(false)
        - wsl_state | default('present') == 'present'
      tags: validation, wsl

    - name: Verify WSL configuration was removed
      ansible.builtin.stat:
        path: /etc/wsl.conf
      register: wsl_conf_check
      failed_when: wsl_conf_check.stat.exists
      when:
        - is_wsl2 | default(false)
        - wsl_state | default('present') == 'absent'
      tags: validation, wsl
